{% extends "base.html" %}

{% block scripts %}
    <script src="{{ url_for('static', filename='/js/textbox.js') }}"></script>
    <script src="{{ url_for('static', filename='/js/textarea.js') }}"></script>
{% endblock %}

{% block content %}
    <h2>Blogs</h2>
    <form method="GET" action="{{url_for('blog_display')}}">
        <input type="text" id="query" name="query" class="autogrow" placeholder="Search for blogs, authors, and tags">
        <button type="Submit">Search</button>
    </form>
    <br>
    {% if blogs %}
        {% for blog in blogs %}
            <section class="blogs">
                <hr>
                <h2>
                    {{ blog.BlogName }}
                </h2>
                <ul>
                    <li>
                        <h3>Written by <a href="{{ url_for('about_me', username=blog.author.Username) }}">{{ blog.author.Username }}</a> |
                            {% if current_user.id == blog.UserID or current_user.is_admin %}
                                <a href="{{ url_for('edit_blog', blog_id=blog.BlogID) }}">Edit</a>
                                    <form method="POST" action="{{ url_for('delete_blog', id=blog.BlogID) }}" style="display:inline;">
                                        <button type="submit">Delete</button>
                                    </form>
                            {% endif %}
                        </h3>
                    </li>
                </ul>
                <h3>Relevant Topics:</h3>
                {% for categoryship in blog.categoryships %}
                    <ul>
                        <li>{{ categoryship.category.CategoryName }}</li>
                    </ul>
                {% endfor %}
                <h3>Images:</h3>
                {% for image in blog.image_paths %}
                    <img src="{{ url_for('static', filename='uploads/' ~ image.filename) }}" alt="Blog Image"
                    style="max-width:300px; height:auto; margin:10px;">
                {% endfor %}
                {%if not image in blog.image_paths%}
                    <p>No images were found for this post.</p>
                {%endif%}
                <h3>Blog Contents:</h3>
                    <p>{{ blog.BlogContents | replace('\n', '<br>') | safe }}</p>
                <h3>Comments</h3>
                <ul>
                    {% if current_user.is_authenticated %}
                        <form method="POST" action="{{url_for('blog_display', query=request.args.get('query'))}}">
                            <strong>Comment as {{ current_user.Username }}:</strong>
                            <br>
                            <input type="hidden" name="BlogID" value="{{blog.BlogID}}">
                            <textarea name="content" class="growtextarea" required></textarea>
                            <br>
                            <button type="submit">Add Comment</button>
                        </form>
                    {% else %}
                        <li>You must <a href="{{url_for('login')}}">login</a> to comment and see comments.</li>
                    {% endif %}
                    <br>
                {% for comment in blog.comments %}
                    {%if current_user.is_authenticated%}
                    <li>
                        <strong>{{ comment.user.Username }}</strong>:

                        {% if current_user.is_authenticated and comment.UserID == current_user.id %}
                            {% if edit_id == comment.CommentID %}
                                <!-- Edit form -->
                                <form method="POST" action="{{ url_for('edit_comment', comment_id=comment.CommentID) }}">
                                    <textarea name="content" class="growtextarea">{{ comment.CommentContents }}</textarea>
                                    <button type="submit">Save</button>
                                    <a href="{{ url_for('blog_display', query=request.args.get('query')) }}">Cancel</a>
                                </form>
                            {% else %}
                                <!-- Normal display with edit/delete buttons -->
                                {{ comment.CommentContents }}
                                <a href="{{ url_for('blog_display', query=request.args.get('query'), edit_id=comment.CommentID) }}">Edit</a>
                            {% endif %}
                            
                            {% if current_user.is_authenticated and (comment.UserID == current_user.id or current_user.IsAdmin) %}
                                <!-- Delete button always shown next to edit -->
                                <form method="POST" action="{{ url_for('delete_comment', comment_id=comment.CommentID) }}" style="display:inline;">
                                    <button type="submit">Delete</button>
                                </form>
                            {% else %}
                                {{ comment.CommentContents }}
                            {% endif %}
                        {% endif %}
                    {%endif%}
                    </li>
                {% endfor %}
                </ul>
                <hr>
            </section>
        {% endfor %}
    {% endif %}
{% endblock %}